#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
# $HOME: /app

set -e

BUILD_DIR=${1:-.}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

HEROKU_DIR=$BUILD_DIR/.heroku
BIN_DIR=$HEROKU_DIR/bin

# To enable the local source build cache path, copy the files and match the build path with the startup path.
cp -rpT $BUILD_DIR $HOME
cd $HOME

# install bun
if [ ! -d "$CACHE_DIR/.bun" ]; then
    echo "-----> Installing Bun"
    curl -fsSL https://bun.sh/install | bash
    mkdir -p "$CACHE_DIR/.bun"
    cp -R "$HOME/.bun" "$CACHE_DIR/.bun"
else
    echo "-----> Using cached Bun"
    cp -R "$CACHE_DIR/.bun" "$HOME/.bun"
fi

# set environment variables
export BUN_INSTALL=$HOME/.bun
export PATH=$BUN_INSTALL/bin:$PATH

PROFILE_PATH="$BUILD_DIR/.profile.d/bun.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export BUN_INSTALL=$HOME/.bun' >> $PROFILE_PATH
echo 'export PATH=$BUN_INSTALL/bin:$PATH' >> $PROFILE_PATH

# download dependencies
echo "-----> Installing Dependencies"
bun install

# build the project
if [ -f heroku_build.ts ]; then
  echo "-----> Running heroku_build.ts"
  bun run heroku_build.ts
elif [ -f bun.config.ts ]; then
  echo "-----> Running Bun build"
  bun run build
fi

# copy the build back to BUILD_DIR
cp -rpT $HOME $BUILD_DIR
