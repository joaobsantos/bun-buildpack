#!/usr/bin/env bash
# NewsoftDS Monorepo Buildpack for Heroku
# Ultra-simple but with full functionality
#
set -e

# ðŸŽ¨ Pretty logging functions
log_header() { echo ""; echo "ðŸš€ $1"; echo ""; }
log_step() { echo "   ðŸ“¦ $1"; }
log_success() { echo "   âœ… $1"; }
log_info() { echo "   â„¹ï¸  $1"; }
log_error() { echo "   âŒ $1"; }

# ðŸ“‚ Directory setup
BUILD_DIR=${1:-.}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

log_header "NewsoftDS Buildpack v4.0"

# ðŸ”§ Export environment variables from Heroku
export_env_dir() {
  if [ -d "$1" ]; then
    for e in $(ls $1); do
      case $e in
        PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH) ;;
        *) export "$e=$(cat $1/$e)" ;;
      esac
    done
  fi
}

export_env_dir $ENV_DIR

# âš™ï¸ Read Bun version from package.json
BUN_VERSION=$(grep -oP '"bun":\s*"\K[^"]+' $BUILD_DIR/package.json 2>/dev/null || echo "1.3.2")

# â— Validate required environment variables
if [ -z "$BP_BUILD" ]; then
  log_error "BP_BUILD environment variable is required!"
  log_info "Set it with: heroku config:set BP_BUILD=@newsoftds/api-gateway-server"
  log_info "Or: heroku config:set BP_BUILD=apis/servers/api-gateway-server"
  log_info "Available projects:"
  find . -name "package.json" -path "*/servers/*" -o -path "*/packages/*" 2>/dev/null | head -5 || true
  log_header "âŒ Build Failed - Missing BP_BUILD"
  exit 1
fi

log_info "Building: $BP_BUILD"
log_info "Bun: $BUN_VERSION"

# ðŸ—ï¸ Setup build environment
HEROKU_DIR=$BUILD_DIR/.heroku
mkdir -p $HEROKU_DIR/bin

# Move to build directory
cd $BUILD_DIR

# ðŸ¥¯ Install Bun
log_step "Installing Bun $BUN_VERSION"

rm -rf $BUILD_DIR/.heroku/cache $BUILD_DIR/.heroku/.cache $BUILD_DIR/.heroku/install 2>/dev/null || true

export BUN_INSTALL=$BUILD_DIR/.heroku
export BUN_DIR=/tmp/bun-cache-$$

BUN_INSTALL_TAG="bun-v$BUN_VERSION"
curl -fsSL https://bun.sh/install | bash -s "$BUN_INSTALL_TAG" > /dev/null 2>&1

export PATH="$BUN_INSTALL/bin:$PATH"

INSTALLED_VERSION=$(bun --version)
if [ "$INSTALLED_VERSION" != "$BUN_VERSION" ]; then
  log_error "Bun version mismatch! Expected $BUN_VERSION but got $INSTALLED_VERSION"
  exit 1
fi

rm -rf /tmp/bun-cache-* 2>/dev/null || true
log_success "Bun $BUN_VERSION installed"

# ðŸ“‹ Setup runtime environment
PROFILE_PATH="$BUILD_DIR/.profile.d/bun.sh"
mkdir -p $(dirname $PROFILE_PATH)
cat > $PROFILE_PATH << 'EOF'
export PATH="$HOME/.heroku/bin:$PATH"
EOF

# ðŸ“¦ Install monorepo dependencies
log_step "Installing dependencies"

bun install --ignore-scripts > /dev/null 2>&1 || {
  log_error "Dependency installation failed"
  bun install --ignore-scripts  # Show errors on retry
  exit 1
}

log_success "Dependencies installed"

# ðŸ—ï¸ Build the project
log_step "Building $BP_BUILD"

# Determine project path - support both @newsoftds/name and path formats
PROJECT_PATH=""
if [[ "$BP_BUILD" == @* ]]; then
  # It's a package name, try to find it
  case $BP_BUILD in
    "@newsoftds/api-gateway-server")
      PROJECT_PATH="apis/servers/api-gateway-server"
      ;;
    "@newsoftds/api-clinic-server")
      PROJECT_PATH="apis/servers/api-clinic-server"
      ;;
    "@newsoftds/api-university-server")
      PROJECT_PATH="apis/servers/api-university-server"
      ;;
    "@newsoftds/portal-paciente")
      PROJECT_PATH="web/packages/portal-paciente"
      ;;
    *)
      # Try to auto-detect
      for project_file in $(find . -name "package.json" -not -path "./node_modules/*" 2>/dev/null); do
        project_name=$(cat "$project_file" | bun -e 'const p=JSON.parse(await Bun.stdin.text()); console.log(p.name || "")' 2>/dev/null)
        if [ "$project_name" = "$BP_BUILD" ]; then
          PROJECT_PATH=$(dirname "$project_file")
          break
        fi
      done
      ;;
  esac
else
  # It's already a path
  PROJECT_PATH="$BP_BUILD"
fi

if [ -z "$PROJECT_PATH" ] || [ ! -d "$PROJECT_PATH" ]; then
  log_error "Project not found: $BP_BUILD"
  log_info "Check that BP_BUILD is either a valid package name or path"
  exit 1
fi

log_info "Project path: $PROJECT_PATH"
cd "$PROJECT_PATH"

# Run build script
if [ -f "package.json" ] && grep -q '"build"' package.json; then
  log_info "Running build script"
  bun run build
else
  log_error "No build script found in package.json"
  log_info "Add a 'build' script to your package.json"
  exit 1
fi

log_success "Build completed"

# ðŸ“¦ Check if dist directory was created
if [ ! -d "dist" ]; then
  log_error "Build did not create a dist directory"
  exit 1
fi

# ðŸ” Detect project type (web vs api)
IS_WEB_PROJECT=false
if [ -f "dist/index.html" ]; then
  IS_WEB_PROJECT=true
  log_info "Detected: Web project (React SPA)"

  # Create server.ts for web projects if it doesn't exist
  if [ ! -f "dist/server.ts" ]; then
    log_info "Injecting production server"
    cat > dist/server.ts << 'SERVEREOF'
#!/usr/bin/env bun
/**
 * Bun static file server for React production build
 * Auto-generated by NewsoftDS Buildpack v4.1
 * Serves static files with SPA routing support
 */

const PORT = process.env.PORT || 3000

Bun.serve({
  port: PORT,

  async fetch(req) {
    const url = new URL(req.url)
    let pathname = url.pathname

    // Default to index.html for root
    if (pathname === '/') {
      pathname = '/index.html'
    }

    // Serve files from current directory
    const filePath = `.${pathname}`
    const file = Bun.file(filePath)
    const exists = await file.exists()

    if (exists) {
      return new Response(file)
    }

    // SPA fallback: serve index.html for any unknown route
    // This allows React Router to handle client-side routing
    const indexFile = Bun.file('./index.html')
    return new Response(indexFile, {
      headers: {
        'Content-Type': 'text/html',
      },
    })
  },
})

console.log(`ðŸš€ Server running on http://localhost:${PORT}`)
console.log(`ðŸ“ Serving from: ${process.cwd()}`)
SERVEREOF
    chmod +x dist/server.ts
    log_success "Server injected"
  else
    log_info "Using existing server.ts"
  fi
else
  log_info "Detected: API project"
fi

# ðŸš€ Prepare deployment
log_step "Preparing deployment"

# Move back to BUILD_DIR to prepare final slug
cd $BUILD_DIR

# Move dist contents to root (where Heroku expects them)
log_info "Moving dist/* to root"
cp -r $PROJECT_PATH/dist/* .

# ðŸ“¦ Install production dependencies
log_step "Installing production dependencies"

# For web projects with server.ts, no dependencies needed!
if [ "$IS_WEB_PROJECT" = true ] && [ -f "server.ts" ]; then
  log_info "Web project with Bun server - no dependencies needed"
  log_success "Installed 0 packages"
else
  # For API projects, we need dependencies
  # Remove monorepo package.json/lockb, use only the project's generated one
  rm -f package.json bun.lockb 2>/dev/null || true

  # Copy the project's package.json if it was generated
  if [ -f "$PROJECT_PATH/package.json" ]; then
    cp "$PROJECT_PATH/package.json" .
  fi

  bun install --production --ignore-scripts > /dev/null 2>&1 || {
    log_error "Production dependency installation failed"
    bun install --production --ignore-scripts  # Show errors
    exit 1
  }

  PACKAGE_COUNT=$(ls -1 node_modules 2>/dev/null | wc -l)
  log_success "Installed $PACKAGE_COUNT packages"
fi

# ðŸŽ¯ Create Procfile
log_step "Creating Procfile"

# Auto-detect start command if not provided
if [ -z "$BP_START" ]; then
  if [ "$IS_WEB_PROJECT" = true ]; then
    BP_START="bun run server.ts"
    log_info "Auto-detected start command: $BP_START"
  elif [ -f "index.js" ]; then
    BP_START="bun run index.js"
    log_info "Auto-detected start command: $BP_START"
  else
    log_error "Could not auto-detect start command. Please set BP_START"
    log_info "For web: heroku config:set BP_START='bun run server.ts'"
    log_info "For API: heroku config:set BP_START='bun run index.js'"
    exit 1
  fi
fi

echo "web: $BP_START" > Procfile
log_success "Procfile created"

# ðŸ§¹ Cleanup
log_step "Cleanup"

# Remove source directories (NOT needed at runtime)
rm -rf apis web desktop packages utils tools apps 2>/dev/null || true
rm -rf .nx .cache tmp .git 2>/dev/null || true
rm -rf *.md *.lock *.lockb tsconfig*.json nx.json biome.json 2>/dev/null || true

# CRITICAL: Remove build-time node_modules (1.4GB!)
# For web projects, we have 0 runtime deps, so delete monorepo node_modules
# For API projects, we skip this - node_modules has production deps
if [ "$IS_WEB_PROJECT" = true ]; then
  log_info "Removing build-time node_modules"
  rm -rf node_modules 2>/dev/null || true
fi

# Clean Bun cache/tmp but KEEP .heroku/bin (where Bun is installed!)
rm -rf .heroku/cache .heroku/tmp .heroku/install 2>/dev/null || true

# Keep .heroku/bin and .profile.d - they're needed at runtime!

SLUG_SIZE=$(du -sh . 2>/dev/null | cut -f1)
log_success "Slug size: $SLUG_SIZE"

# ðŸ“Š Summary
log_header "Build Complete"
log_success "$BP_BUILD â†’ $SLUG_SIZE"
log_success "Runtime: Bun $BUN_VERSION"
log_success "Start: $BP_START"